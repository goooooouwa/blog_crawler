<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
<channel>
<title>Coding Horror</title>
<description>programming and human factors</description>
<link>https://blog.codinghorror.com/</link>
<pubDate>Sun, 19 Apr 2020 00:00:01 GMT</pubDate>
<!-- other elements omitted from this example -->
<item>
<title>ASP.NET NTLM Authentication - is it worth it?</title>
<link>https://blog.codinghorror.com/aspnet-ntlm-authentication-is-it-worth-it/</link>
<content>
                <!--kg-card-begin: markdown--><p>
At work, we have the luxury of assuming that everyone's on an intranet. So when it comes to identity management on our ASP.NET websites, <a href="http://dotnetjunkies.com/Article/6B31D299-347C-4B85-82C5-954546165C80.dcik">NTLM authentication</a> is the go-to solution. Why trouble the user with Yet Another Login Dialog when you can leverage the built in NTLM functionality of IIS and Internet Explorer? Just reach in and grab one of these <code>Request.ServerVariables</code> passed in through the HTTP headers:
</p>
<p>
</p>
<pre>
LOGON_USER  = HOMESERVERJeff
AUTH_USER   = HOMESERVERJeff
REMOTE_USER = HOMESERVERJeff
</pre>
<p>
I don't pretend to understand the subtle difference between these three fields; <a href="http://www.codeproject.com/asp/request_server_variables.asp">this CodeProject article</a> has some hints. At any rate, at least one of them will contain the domainusername of the user accessing our web page. And it's free-- as long as you define "free" as <b>three browser round trips</b>:
</p>
<p>
</p>
<pre>
<b>GET /WebApplication1/WebForm2.aspx HTTP/1.1</b>
User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322)
Host: homeserver
Connection: Keep-Alive
<b>HTTP/1.1 <span style="color:darkblue">401 Unauthorized</span></b>
Content-Length: 1656
Content-Type: text/html
Server: Microsoft-IIS/6.0
<span style="color:red">WWW-Authenticate: NTLM
WWW-Authenticate: Basic realm="homeserver"</span>
Date: Thu, 14 Apr 2005 02:59:26 GMT
<b>GET /WebApplication1/WebForm2.aspx HTTP/1.1</b>
User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322)
Host: homeserver
Connection: Keep-Alive
<span style="color:red">Authorization: NTLM TlRMTVNTUAABAAAAB7IIogQABAAwAAAACAAIACgAAAAFASgKAAAAD1dVTVBVUzY0SE9NRQ=
=</span>
<b>HTTP/1.1 <span style="color:darkblue">401 Unauthorized</span></b>
Content-Length: 1539
Content-Type: text/html
Server: Microsoft-IIS/6.0
<span style="color:red">WWW-Authenticate: NTLM TlRMTVNTUAACAAAAFAAUADgAAAAFgoqiMixeuxRDQq8AAAAAAAAAAKgAqABMAAAABQLO
DgAAAA9IAE8ATQBFAFMARQBSAFYARQBSAAIAFABIAE8ATQBFAFMARQBSAFYARQBSAAEAFABIAE8ATQBFAFMARQBSAFY
ARQBSAAQANgBoAG8AbQBlAHMAZQByAHYAZQByAC4AYwBvAGQAaQBuAGcAaABvAHIAcgBvAHIALgBjAG8AbQADADYAaA
BvAG0AZQBzAGUAcgB2AGUAcgAuAGMAbwBkAGkAbgBnAGgAbwByAHIAbwByAC4AYwBvAG0AAAAAAA==</span>
Date: Thu, 14 Apr 2005 02:59:26 GMT
<b>GET /WebApplication1/WebForm2.aspx HTTP/1.1</b>
User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; .NET CLR 1.1.4322)
Host: homeserver
<span style="color:red">Authorization: NTLM TlRMTVNTUAADAAAAGAAYAGwAAAAYABgAhAAAAAwADABIAAAACAAIAFQAAAAQABAAXAAAAAA
AAACcAAAABYKIogUBKAoAAAAPVwBVAE0AUABVAFMASgBlAGYAZgBXAFUATQBQAFUAUwA2ADQAhUEDudJHhNcAAAAAAA
AAAAAAAAAAAAAA74hHe6W7Di69Hgo553hEc7OZLaIizpzh</span>
<b>HTTP/1.1 <span style="color:darkblue">200 OK</span></b>
Cache-Control: private
Date: Thu, 14 Apr 2005 02:59:26 GMT
Content-Type: text/html; charset=utf-8
Server: Microsoft-IIS/6.0
Set-Cookie: ASP.NET_SessionId=0nispyqogdrmpjyxnzxe2b55; path=/
Content-Encoding: gzip
Vary: Accept-Encoding
Transfer-Encoding: chunked
</pre>
<p>
This is the classic challenge-response handshaking sequence that Eric Lippert described in his recent entry <a href="http://blogs.msdn.com/ericlippert/archive/2005/02/07/368569.aspx">You Want Salt With That? Part Four: Challenge-Response</a>. And it really does work; no passwords are ever transmitted, and yet we know exactly who the user is.
</p>
<p>
Although it is delightfully easy to implement, NTLM authentication carries a <b>hefty performance cost</b>. How hefty? The last time I benchmarked it, almost 1000ms per request, compared to under 20ms for anonymous requests. And there are a lot of other caveats, too:
</p>
<ul>
<li>IE will only send NTLM credentials <i>automatically</i> to <a href="http://cyberforge.com/weblog/aniltj/archive/2004/10/25/705.aspx">sites it deems in the "Intranet Zone"</a>. Websites in any other security zone will pop up a login prompt.
</li>
<li>NTLM credentials typically <a href="http://groups-beta.google.com/group/microsoft.public.isa/browse_thread/thread/ba3ffbe8672abbe7/fdda0233b1d78474?rnum=9#fdda0233b1d78474">don't make it through a proxy</a>, so you must enable Basic authentication in addition to NTLM, otherwise you risk permanently blocking a chunk of your userbase from your application. And Basic authentication is, uh, unsecure. Like "barely better than plain text" unsecure.
</li>
<li>If you have users coming in from multiple domains, you must set authentication to use "all domains" via <a href="http://support.microsoft.com/?id=827991">the backslash trick</a>. This leads to another problem: if users have accounts with the same name in other domains, those accounts will take priority.
</li>
<li>All new folders in IIS default to Integrated and Anonymous authentication. This seems contradictory; will NTLM be used, or will everyone map to the anonymous account? The Windows Server 2003 Directory Security dialog clarifies this at long last: anonymous will be used unless NTFS access control lists are specified on that folder. And how do we know that, exactly?
</li>
<li>It's also possible to control authentication via ASP.NET's &lt;authorization&gt; Web.config section. But this <i>only</i> works if the IIS Directory Security settings are left at their default of Integrated and Anonymous. IIS settings will overrule whatever you specify in Web.config.
</li>
<li>Integrated authentication checks the user's Windows account at the time they access your website. If there is any problem with a given user's Windows account, they won't be able to access your website.  Is that user temporarily locked out? Password expired? Must change password at next logon? Are there network problems preventing your webserver from communicating with other domains? This inevitably results in a lot of user complaints that "I can't get to your intranet site, but all the others work-- what's wrong with your site?" Those other sites don't use NTLM. And I am put in the uncomfortable position of troubleshooting people's Windows accounts so they can get to our website.
</li>
</ul>
<p>
I used to be a big believer in NTLM authentication in ASP.NET. However, after living with it for the last two years, I'm starting to wonder if we wouldn't all be better off with Yet Another Login Dialog.
</p>
<p>
</p>
<p></p>
<!--kg-card-end: markdown-->
            </content>
<pubDate>2005-04-13T12:00:00.000Z</pubDate>
<guid>https://blog.codinghorror.com/aspnet-ntlm-authentication-is-it-worth-it/</guid>
</item>
</channel>
</rss>
